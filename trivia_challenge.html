<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MULAFLOWR - Trivia Challenge</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <style>
    /* Styles (identiques à ton fichier, condensés pour la lecture) */
    body {
      background: linear-gradient(135deg, #d5e8d9 0%, #c5dfe6 100%);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      visibility: hidden; 
      opacity: 0;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    body.loaded { visibility: visible; opacity: 1; }

    :root {
      --primary-color: #3a8ee6;
      --primary-light: #4da6ff;
      --primary-dark: #2c75c9;
      --secondary-color: #4c566a;
      --background-light: #f5f7fb;
      --card-bg: #ffffff;
      --text-color: #2e3440;
      --text-light: #4c566a;
      --success-color: #4CD964;
      --danger-color: #FF3B30;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; transition: all .25s ease; }

    .loader-container { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(135deg,#d5e8d9,#c5dfe6); }
    .loader { width:60px;height:60px;border-radius:50%; background:conic-gradient(#0000 10%, var(--primary-color)); -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 8px), #000 0); animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(1turn); } }

    .header{ background:var(--card-bg); box-shadow:var(--shadow); padding:15px 30px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
    .logo{ font-weight:800; color:var(--primary-color); font-family:'Montserrat',sans-serif; }

    .main-container{ display:flex; flex:1; min-height:calc(100vh - 160px); }
    .sidebar{ width:280px; background:rgba(255,255,255,0.8); padding:25px 0; height:calc(100vh - 80px); position:sticky; top:80px; overflow:auto; box-shadow:var(--shadow); }
    .content{ flex:1; padding:30px; }

    .trivia-section{ background:linear-gradient(135deg,#e6f7ff,#b3e0ff); border-radius:12px; padding:25px; box-shadow:var(--shadow); margin-bottom:30px; position:relative; }
    .section-title{ font-size:1.3rem; color:var(--secondary-color); margin-bottom:12px; }
    .question-container{ background:rgba(255,255,255,0.85); padding:20px; border-radius:10px; margin-bottom:15px; }
    .question-text{ font-weight:700; margin-bottom:12px; color:var(--text-color); }
    .options-container{ display:grid; gap:10px; }
    .option{ padding:12px 15px; background:var(--background-light); border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:10px; }
    .option:hover{ background:var(--primary-light); color:white; transform:translateY(-2px); }
    .option.selected{ background:var(--primary-color); color:white; }
    .option.correct{ background:var(--success-color); color:white; }
    .option.incorrect{ background:var(--danger-color); color:white; }

    .action-buttons{ display:flex; gap:12px; justify-content:center; margin-top:18px; }
    .btn{ padding:10px 18px; border-radius:8px; border:none; font-weight:700; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
    .btn-primary{ background:linear-gradient(135deg,var(--primary-color),var(--primary-dark)); color:white; }
    .btn-success{ background:linear-gradient(135deg,var(--success-color),#2AB32A); color:white; }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; transform:none; }

    .progress-bar{ height:10px; background:var(--background-light); border-radius:5px; overflow:hidden; margin-bottom:12px; }
    .progress-fill{ height:100%; background:linear-gradient(135deg,var(--primary-color),var(--primary-dark)); transition:width .3s ease; }

    .results-container{ display:none; background:rgba(255,255,255,0.9); padding:20px; border-radius:10px; text-align:center; }
    .results-title{ font-weight:800; margin-bottom:8px; }
    .results-score{ font-size:2rem; font-weight:800; color:var(--primary-color); margin-bottom:8px; }
    .reward-info{ background:linear-gradient(135deg,#e6ffed,#b3ffc9); padding:12px; border-radius:8px; margin:12px 0; }
    .notification-container{ position:fixed; top:20px; right:20px; display:flex; flex-direction:column; gap:10px; z-index:9999; pointer-events:none; }

    .daily-stats{ display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin-top:20px; }
    .stat-card{ background:linear-gradient(135deg,#f0f8ff,#e0f0ff); padding:15px; border-radius:10px; box-shadow:var(--shadow); text-align:center; }
    .stat-value{ font-weight:800; color:var(--primary-color); font-size:1.4rem; }

    .overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:98; }
    .notification{ padding:12px 15px; border-radius:8px; color:white; box-shadow:0 4px 12px rgba(0,0,0,0.15); pointer-events:auto; display:flex; gap:10px; align-items:flex-start; }
    .notification.success{ background:linear-gradient(135deg,var(--success-color),#2AB32A); }
    .notification.error{ background:linear-gradient(135deg,var(--danger-color),#c0392b); }
    .notification.info{ background:linear-gradient(135deg,var(--primary-color),var(--primary-dark)); }
  </style>
</head>
<body>
  <div class="loader-container" id="loader"><div class="loader"></div></div>
  <div class="notification-container" id="notificationContainer"></div>

  <header class="header">
    <div class="logo">MULAFLOWR</div>
    <div class="header-controls">
      <button class="language-selector"><i class="fas fa-globe"></i> French</button>
    </div>
  </header>

  <div class="overlay" id="overlay"></div>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <div class="welcome-section">
        <div class="welcome-text">Trivia Challenge &nbsp;&gt;&gt; MULAFLOWR</div>
        <div class="username" id="sidebarUsername">Utilisateur</div>
      </div>
      <!-- menu réduit -->
      <nav>
        <a href="dashboard.html" class="menu-item">Tableau de bord</a>
        <a href="tiktok_earn.html" class="menu-item">TikTok Earn</a>
        <a href="trivia_challenge.html" class="menu-item active">TRIVIA challenge</a>
      </nav>
    </aside>

    <main class="content">
      <h1 class="page-title"><i class="fas fa-brain"></i> Trivia Challenge</h1>

      <div class="trivia-section">
        <h2 class="section-title">Testez vos connaissances et gagnez de l'argent</h2>

        <div class="progress-container">
          <div class="progress-text" id="progressText">Question 1/5</div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:20%"></div></div>
        </div>

        <div class="question-container" id="questionContainer">
          <div class="question-text" id="questionText">Chargement de la question...</div>
          <div class="options-container" id="optionsContainer"></div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="submitButton" disabled><i class="fas fa-paper-plane"></i><span>Soumettre la réponse</span></button>
          <button class="btn btn-success" id="nextButton" style="display:none;"><i class="fas fa-arrow-right"></i><span>Question suivante</span></button>
        </div>

        <div class="results-container" id="resultsContainer">
          <div class="results-title">Résultats du Quiz</div>
          <div class="results-score" id="resultsScore">0/5</div>
          <div class="results-message" id="resultsMessage"></div>

          <div class="reward-info">
            <div class="reward-amount" id="rewardAmount">+0 FCFA</div>
            <div class="reward-text" id="rewardText">Gains pour ce quiz</div>
          </div>

          <div class="action-buttons" style="justify-content:center;">
            <button class="btn btn-primary" id="claimButton"><i class="fas fa-coins"></i><span>Réclamer la récompense</span></button>
            <button class="btn btn-primary" id="restartButton"><i class="fas fa-redo"></i><span>Recommencer</span></button>
          </div>
        </div>
      </div>

      <div class="daily-stats">
        <div class="stat-card">
          <div class="stat-value" id="quizzesCompleted">0</div>
          <div class="stat-label">Quiz complétés aujourd'hui</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="earnedToday">0 FCFA</div>
          <div class="stat-label">Gagné aujourd'hui</div>
        </div>
      </div>
    </main>
  </div>

  <footer style="text-align:center; padding:18px; background:#fff; margin-top:20px;">
    © 2025 MULAFLOWR. Tous droits réservés.
  </footer>

<script>
/******** CONFIG FIREBASE ********/
const firebaseConfig = {
  apiKey: "AIzaSyCjGisjgbFc2ZE0BFgdhlUao8bCCeuKP1k",
  authDomain: "cash-flowr.firebaseapp.com",
  projectId: "cash-flowr",
  storageBucket: "cash-flowr.appspot.com",
  messagingSenderId: "1091928501310",
  appId: "1:1091928501310:web:4f4de306cde36f378ff56f",
  measurementId: "G-5SF6VDLZCB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/******** DOM Elements ********/
const loader = document.getElementById('loader');
const notificationContainer = document.getElementById('notificationContainer');
const sidebarUsername = document.getElementById('sidebarUsername');

const progressText = document.getElementById('progressText');
const progressFill = document.getElementById('progressFill');
const questionText = document.getElementById('questionText');
const optionsContainer = document.getElementById('optionsContainer');
const submitButton = document.getElementById('submitButton');
const nextButton = document.getElementById('nextButton');
const resultsContainer = document.getElementById('resultsContainer');
const resultsScore = document.getElementById('resultsScore');
const resultsMessage = document.getElementById('resultsMessage');
const rewardAmount = document.getElementById('rewardAmount');
const rewardText = document.getElementById('rewardText');
const claimButton = document.getElementById('claimButton');
const restartButton = document.getElementById('restartButton');
const quizzesCompleted = document.getElementById('quizzesCompleted');
const earnedToday = document.getElementById('earnedToday');

/******** State ********/
let currentUser = null;
let userData = {};
let isEasyMode = true;

let questionPool = [];
let currentQuestions = [];
let currentQuestionIndex = 0;
let selectedOption = null;
let score = 0;

let pendingReward = 0;            // montant à réclamer pour la session courante
let pendingSessionId = null;      // identifiant unique de la session (empêche double claim)
const FIRST_TIME_FIXED_REWARD = 500;
const PER_QUESTION_REWARD_HARD = 150;
const PER_QUESTION_REWARD_EASY = 100;
const MAX_INCREMENT_PER_REQUEST = 500; // sécurité identique au TikTok
const QUIZ_SIZE = 5;

/******** Questions (easy fixed block + large hard pool) ********/
const easyQuestions = [
  { question: "Quel fruit est jaune ?", options: ["Banane", "Pomme", "Orange", "Raisin"], correctAnswer: 0 },
  { question: "Quelle est la capitale de la France ?", options: ["Lyon", "Paris", "Marseille", "Bordeaux"], correctAnswer: 1 },
  { question: "Combien de côtés a un triangle ?", options: ["3", "4", "5", "6"], correctAnswer: 0 },
  { question: "Quel animal dit 'meow' ?", options: ["Chien", "Chat", "Vache", "Oiseau"], correctAnswer: 1 },
  { question: "Quelle planète est appelée la planète rouge ?", options: ["Terre", "Mars", "Jupiter", "Vénus"], correctAnswer: 1 }
];

// Hard pool : élargi pour rendre le quiz aléatoire et difficile
const hardPool = [
  { question: "Quel physicien est à l'origine de la théorie de la relativité restreinte ?", options: ["Isaac Newton","Niels Bohr","Albert Einstein","James Clerk Maxwell"], correctAnswer: 2 },
  { question: "En informatique, que signifie 'RSA' ?", options: ["Rapid System Access","Rivest–Shamir–Adleman","Random Sequence Algorithm","Remote Secure Access"], correctAnswer: 1 },
  { question: "Quel est le plus grand organe du corps humain ?", options: ["Le foie","La peau","Le cœur","Le rein"], correctAnswer: 1 },
  { question: "Qui a écrit 'À la recherche du temps perdu' ?", options: ["Marcel Proust","Jean-Paul Sartre","Honoré de Balzac","Stendhal"], correctAnswer: 0 },
  { question: "Quelle est la valeur de pi (π) arrondie à 3 décimales ?", options: ["3.132","3.142","3.152","3.162"], correctAnswer: 1 },
  { question: "Quel est l'élément chimique qui a pour numéro atomique 6 ?", options: ["Azote","Carbone","Oxygène","Hydrogène"], correctAnswer: 1 },
  { question: "Quel pays fut dirigé par Nelson Mandela après la fin de l'apartheid ?", options: ["Zimbabwe","Afrique du Sud","Namibie","Botswana"], correctAnswer: 1 },
  { question: "Quel mathématicien a démontré l'inexistence d'une solution générale en équations quintiques (Théorème d'Abel-Ruffini) ?", options: ["Évariste Galois","Niels Henrik Abel","Carl Friedrich Gauss","Joseph-Louis Lagrange"], correctAnswer: 1 },
  { question: "Laquelle de ces langues est une langue sino-tibétaine ?", options: ["Hindi","Japonais","Mandarin","Turc"], correctAnswer: 2 },
  { question: "Quel acronyme désigne le protocole sécurisé pour les transferts web (HTTPS) ?", options: ["Hyper Transfer Secure","Hypertext Transfer Protocol Secure","Host Transfer Protocol Secure","Hypertext Transport Protection Secure"], correctAnswer: 1 },
  { question: "Quelle galaxie est la plus proche de la Voie lactée ?", options: ["Galaxie du Sombrero","Andromède","Triangulum","Grande Nébuleuse de Magellan"], correctAnswer: 1 },
  { question: "Qui a composé la 9ème symphonie (Ode à la joie) ?", options: ["Mozart","Beethoven","Bach","Chopin"], correctAnswer: 1 },
  { question: "Quel est le principal gaz à effet de serre émis par les activités humaines ?", options: ["Oxygène","Nitrate","Dioxyde de carbone (CO2)","Argon"], correctAnswer: 2 },
  { question: "En électronique, que mesure l'ohmmètre ?", options: ["La tension","L'intensité","La résistance","La puissance"], correctAnswer: 2 },
  { question: "Quel traité a mis fin à la Première Guerre mondiale ?", options: ["Traité de Paris","Traité de Versailles","Traité de Rome","Traité de Brest-Litovsk"], correctAnswer: 1 },
  { question: "Quel pays a inventé le papier ?", options: ["Inde","Égypte","Chine","Grèce"], correctAnswer: 2 },
  { question: "Quel est le nombre d'or approximatif (φ) arrondi à 3 décimales ?", options: ["1.618","1.414","1.732","1.324"], correctAnswer: 0 },
  { question: "Quel est l'instrument principal pour mesurer la pression atmosphérique ?", options: ["Thermomètre","Baromètre","Hygromètre","Altimètre"], correctAnswer: 1 },
  { question: "Qui est l'auteur de '1984' ?", options: ["Aldous Huxley","George Orwell","Ray Bradbury","Philip K. Dick"], correctAnswer: 1 },
  { question: "Quelle unité mesure l'intensité électrique ?", options: ["Volt","Ohm","Ampère","Watt"], correctAnswer: 2 }
];

/******** UI helper: notifications ********/
function showNotification(type, title, message, duration = 3500) {
  const n = document.createElement('div');
  n.className = `notification ${type}`;
  n.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':'fa-info-circle'}"></i>
    <div style="line-height:1.1">
      <strong style="display:block">${title}</strong>
      <span>${message}</span>
    </div>`;
  notificationContainer.appendChild(n);
  setTimeout(()=> {
    n.style.opacity = '0';
    setTimeout(()=> { try{ notificationContainer.removeChild(n); } catch(e){} }, 300);
  }, duration);
}

/******** Helpers date/time ********/
function getTodayString() {
  // Simple stable representation
  const d = new Date();
  return d.toDateString();
}

/******** Quiz control ********/
function startQuiz() {
  selectedOption = null;
  currentQuestionIndex = 0;
  score = 0;
  pendingReward = 0;
  pendingSessionId = `trivia_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;

  // isEasyMode determined at initQuiz
  if (isEasyMode) {
    // First-time: use the fixed easyQuestions block in the defined order
    currentQuestions = [...easyQuestions];
  } else {
    // Later: build a random set of QUIZ_SIZE questions from hardPool
    currentQuestions = shuffleArray(hardPool).slice(0, QUIZ_SIZE).map(q => ({...q}));
  }

  // UI reset
  resultsContainer.style.display = 'none';
  document.getElementById('questionContainer').style.display = 'block';
  submitButton.style.display = 'inline-flex';
  nextButton.style.display = 'none';
  claimButton.disabled = true;
  restartButton.disabled = true;

  loadQuestion();
  updateProgress();
}

function loadQuestion() {
  const q = currentQuestions[currentQuestionIndex];
  questionText.textContent = q.question;
  optionsContainer.innerHTML = '';
  q.options.forEach((opt, idx) => {
    const el = document.createElement('div');
    el.className = 'option';
    el.dataset.index = idx;
    el.innerHTML = `<div class="option-label">${opt}</div>`;
    el.addEventListener('click', ()=> selectOption(el, idx));
    optionsContainer.appendChild(el);
  });

  selectedOption = null;
  submitButton.disabled = true;
}

function selectOption(el, idx) {
  document.querySelectorAll('.option').forEach(o=> o.classList.remove('selected'));
  el.classList.add('selected');
  selectedOption = idx;
  submitButton.disabled = false;
}

function submitAnswer() {
  if (selectedOption === null) return;
  const q = currentQuestions[currentQuestionIndex];
  const optionsEls = document.querySelectorAll('.option');

  // disable clicks
  optionsEls.forEach(o => o.style.pointerEvents = 'none');

  // mark correct/incorrect visuals
  const correctEl = optionsEls[q.correctAnswer];
  correctEl.classList.add('correct');
  if (selectedOption !== q.correctAnswer) {
    const selEl = optionsEls[selectedOption];
    if (selEl) selEl.classList.add('incorrect');
    showNotification('error', 'Mauvaise réponse', `La bonne réponse était: ${q.options[q.correctAnswer]}`);
  } else {
    score++;
    const perQ = isEasyMode ? PER_QUESTION_REWARD_EASY : PER_QUESTION_REWARD_HARD;
    showNotification('success', 'Bonne réponse !', `Vous avez gagné ${perQ} FCFA pour cette question.`);
  }

  // after answering, show next button (or finish)
  submitButton.style.display = 'none';
  nextButton.style.display = 'inline-flex';
}

function nextQuestion() {
  currentQuestionIndex++;
  if (currentQuestionIndex < currentQuestions.length) {
    loadQuestion();
    submitButton.style.display = 'inline-flex';
    nextButton.style.display = 'none';
    updateProgress();
  } else {
    // Finish quiz: compute pendingReward but DO NOT write to Firestore yet
    showResults();
  }
}

function updateProgress() {
  progressText.textContent = `Question ${Math.min(currentQuestionIndex+1, currentQuestions.length)}/${currentQuestions.length}`;
  progressFill.style.width = `${((currentQuestionIndex) / currentQuestions.length) * 100}%`;
}

/******** Show results (prepare pending reward) ********/
function showResults() {
  // compute reward but do not persist here — persist only on claim
  let totalEarnings;
  if (isEasyMode && !userData.triviaFirstCompleted) {
    // First-time fixed reward for completion
    totalEarnings = FIRST_TIME_FIXED_REWARD;
    rewardText.textContent = 'Récompense spéciale pour votre premier quiz (5 questions)';
  } else {
    const perQ = isEasyMode ? PER_QUESTION_REWARD_EASY : PER_QUESTION_REWARD_HARD;
    totalEarnings = score * perQ;
    rewardText.textContent = `Récompense basée sur vos bonnes réponses (${perQ} FCFA / bonne réponse)`;
  }

  pendingReward = totalEarnings;
  rewardAmount.textContent = `+${pendingReward} FCFA`;
  resultsScore.textContent = `${score}/${currentQuestions.length}`;

  if (score === currentQuestions.length) {
    resultsMessage.textContent = 'Félicitations! Vous avez répondu correctement à toutes les questions!';
  } else if (score >= currentQuestions.length / 2) {
    resultsMessage.textContent = 'Bon travail! Vous avez bien répondu à la plupart des questions.';
  } else {
    resultsMessage.textContent = 'Continuez à vous améliorer! Vous ferez mieux la prochaine fois.';
  }

  // show UI
  document.getElementById('questionContainer').style.display = 'none';
  resultsContainer.style.display = 'block';
  claimButton.disabled = false;
  restartButton.disabled = false;
  progressFill.style.width = `100%`;
}

/******** Claim reward (server attempt then Firestore transaction fallback) ********/
claimButton.addEventListener('click', async () => {
  if (!currentUser) { showNotification('error','Non connecté','Veuillez vous connecter.'); return; }
  if (!pendingReward || pendingReward <= 0) { showNotification('info','Rien à réclamer','Aucune récompense disponible.'); return; }

  // Prevent double-click
  claimButton.disabled = true;

  try {
    const user = auth.currentUser;
    if (!user) throw new Error('Session expirée.');

    // 1) Try server endpoint first (if exists)
    try {
      const idToken = await user.getIdToken(true).catch(()=>null);
      const headers = {'Content-Type':'application/json'};
      if (idToken) headers['Authorization'] = 'Bearer ' + idToken;

      const resp = await fetch('/api/trivia-claim-reward', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          idToken,
          rewardAmount: pendingReward,
          sessionId: pendingSessionId
        })
      });

      const text = await resp.text().catch(()=>null);
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e) { data = null; }

      if (resp.ok && data && data.success) {
        // server accepted -> update local UI state
        // expected server response: newBalance, quizzesCompletedToday, earningsToday
        userData = userData || {};
        userData.solde = typeof data.newBalance === 'number' ? data.newBalance : ( (userData.solde||0) + pendingReward );
        userData.triviaGains = (userData.triviaGains||0) + pendingReward;
        userData.triviaCompletedToday = (userData.triviaCompletedToday||0) + 1;
        userData.triviaEarningsToday = (userData.triviaEarningsToday||0) + pendingReward;
        userData.lastTriviaDate = getTodayString();
        userData.triviaClaimedSessions = Array.isArray(userData.triviaClaimedSessions)? userData.triviaClaimedSessions : [];
        userData.triviaClaimedSessions.push(pendingSessionId);
        if (isEasyMode && !userData.triviaFirstCompleted) userData.triviaFirstCompleted = true;

        // local UI update
        quizzesCompleted.textContent = userData.triviaCompletedToday || 0;
        earnedToday.textContent = `${userData.triviaEarningsToday || 0} FCFA`;

        showNotification('success','Récompense ajoutée', `${pendingReward} FCFA ajouté. Nouveau solde: ${data.newBalance ?? 'inconnu'}`);
        claimButton.disabled = true;
        return;
      } else {
        console.warn('Server claim failed or returned non-json:', resp.status, text);
      }
    } catch (serverErr) {
      console.warn('Erreur fetch serveur (fallback):', serverErr);
    }

    // 2) Fallback: Firestore transaction similar à TikTok
    const uid = user.uid;
    const userRef = db.collection('users').doc(uid);
    const todayStr = getTodayString();

    await db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      if (!snap.exists) throw new Error('Utilisateur introuvable.');

      const doc = snap.data() || {};
      // reset daily fields if not today
      const lastDate = doc.lastTriviaDate || null;
      let completedTodayDoc = Number(doc.triviaCompletedToday || 0);
      let earningsTodayDoc = Number(doc.triviaEarningsToday || 0);
      let soldeDoc = Number(doc.solde || 0);
      let triviaGainsDoc = Number(doc.triviaGains || 0);
      let profitDoc = Number(doc.profit || 0);
      let claimedSessions = Array.isArray(doc.triviaClaimedSessions) ? doc.triviaClaimedSessions.slice() : [];

      if (lastDate !== todayStr) {
        completedTodayDoc = 0;
        earningsTodayDoc = 0;
        claimedSessions = [];
      }

      // double-claim protection
      if (claimedSessions.indexOf(pendingSessionId) !== -1) {
        throw new Error('Vous avez déjà réclamé cette session.');
      }

      // defensive increment checks
      if (pendingReward > MAX_INCREMENT_PER_REQUEST) {
        throw new Error('Montant par requête trop élevé.');
      }

      // compute new values
      const newSolde = soldeDoc + pendingReward;
      const newTriviaGains = triviaGainsDoc + pendingReward;
      const newEarningsToday = earningsTodayDoc + pendingReward;
      const newCompletedToday = completedTodayDoc + 1;
      const newProfit = profitDoc + pendingReward;

      // safety checks mirroring rules
      if ((newProfit - profitDoc) > MAX_INCREMENT_PER_REQUEST) throw new Error('Increment profit > allowed');
      if ((newTriviaGains - triviaGainsDoc) > MAX_INCREMENT_PER_REQUEST) throw new Error('Increment triviaGains > allowed');
      if ((newEarningsToday - earningsTodayDoc) > MAX_INCREMENT_PER_REQUEST) throw new Error('Increment triviaEarningsToday > allowed');

      // add session id
      claimedSessions.push(pendingSessionId);

      const updateObj = {
        solde: newSolde,
        triviaGains: newTriviaGains,
        triviaEarningsToday: newEarningsToday,
        triviaCompletedToday: newCompletedToday,
        lastTriviaDate: todayStr,
        triviaClaimedSessions: claimedSessions,
        profit: newProfit
      };

      // mark first complete if needed
      if (isEasyMode && !doc.triviaFirstCompleted) {
        updateObj.triviaFirstCompleted = true;
      }

      tx.update(userRef, updateObj);
    });

    // transaction success -> update local state/UI
    // We'll reload the important fields from server to be safe
    const newDoc = await db.collection('users').doc(uid).get();
    if (newDoc.exists) {
      userData = newDoc.data() || userData;
      quizzesCompleted.textContent = userData.triviaCompletedToday || 0;
      earnedToday.textContent = `${userData.triviaEarningsToday || 0} FCFA`;
    }

    showNotification('success','Récompense ajoutée', `${pendingReward} FCFA ajouté à votre solde.`);
    claimButton.disabled = true;

  } catch (err) {
    console.error('Erreur lors de la réclamation:', err);
    const msg = (err && err.message) ? err.message : 'Impossible d\'appliquer la récompense.';
    showNotification('error','Erreur', msg);
    // reenabler claim button so user puisse retenter
    claimButton.disabled = false;
  }
});

/******** Restart logic ********/
restartButton.addEventListener('click', () => {
  // we can allow restart but respect a per-day max if desired; here we allow replay but set isEasyMode=false after first done
  if (userData && userData.triviaCompletedToday >= 2) {
    showNotification('info','Limite atteinte', 'Vous avez atteint 2 quiz aujourd\'hui. Revenez demain!');
    return;
  }

  // After first quiz completion, always switch to hard mode
  if (isEasyMode) isEasyMode = false;
  startQuiz();
});

/******** Utilitaires ********/
function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length -1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/******** Load & Init user data ********/
async function loadUserData() {
  if (!currentUser) throw new Error('Aucun utilisateur connecté.');
  const userRef = db.collection('users').doc(currentUser.uid);
  const doc = await userRef.get();
  if (doc.exists) {
    userData = doc.data() || {};
  } else {
    // seed minimal structure
    userData = {
      triviaCompletedToday: 0,
      triviaEarningsToday: 0,
      lastTriviaDate: null,
      solde: 0,
      triviaGains: 0,
      triviaClaimedSessions: []
    };
    await userRef.set(userData);
  }

  // Reset daily counters if lastTriviaDate isn't today
  const today = getTodayString();
  if ((userData.lastTriviaDate || '') !== today) {
    userData.triviaCompletedToday = 0;
    userData.triviaEarningsToday = 0;
    // no immediate save — will save on claim; but update UI now
  }
  return userData;
}

/******** Update UI user info and daily stats ********/
function updateUserInfoUI(user, dbData = {}) {
  const displayName = dbData.displayName || user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');
  if (sidebarUsername) sidebarUsername.textContent = displayName;
}
function updateDailyStatsUI() {
  quizzesCompleted.textContent = userData.triviaCompletedToday || 0;
  earnedToday.textContent = `${userData.triviaEarningsToday || 0} FCFA`;
}

/******** Auth & main init ********/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    try {
      // load userData
      await loadUserData();

      // set first-time mode : easy if they never completed the first tutorial-trivia
      isEasyMode = !(userData.triviaFirstCompleted === true);

      updateUserInfoUI(user, userData);
      updateDailyStatsUI();

      // start quiz
      startQuiz();

      document.body.classList.add('loaded');
      if (loader) loader.style.display = 'none';
      showNotification('success','Bienvenue!', 'Prêt pour le Trivia Challenge!');

    } catch (err) {
      console.error('Erreur initialisation trivia:', err);
      showNotification('error','Erreur critique', 'Impossible de charger vos données. Veuillez vous reconnecter.');
      auth.signOut();
      setTimeout(()=> { window.location.href = 'login.html'; }, 2000);
    }
  } else {
    // pas connecté -> renvoyer à login
    window.location.href = 'login.html';
  }
});

/******** Event handlers ********/
submitButton.addEventListener('click', submitAnswer);
nextButton.addEventListener('click', nextQuestion);

/******** Petit preload & safety ********/
document.addEventListener('DOMContentLoaded', ()=> {
  setTimeout(()=> { if (loader) loader.style.display = 'none'; }, 600);
});
</script>
</body>
</html>