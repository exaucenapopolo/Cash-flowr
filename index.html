<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cash-flowr - Inscription</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- CSS existant --- */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    body{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#333;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{width:100%;max-width:480px;margin:0 auto}
    .logo-header{text-align:center;margin-bottom:20px}
    .logo{font-size:2.8rem;font-weight:700;color:white;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
    .logo i{margin-right:10px;color:#4CD964}
    .tagline{color:rgba(255,255,255,0.8);font-size:1.1rem;margin-bottom:10px}
    .card{background-color:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;padding:25px}
    .card-header{text-align:center;margin-bottom:25px}
    .card-header h2{color:#2c3e50;font-size:1.8rem;font-weight:600;margin-bottom:8px}
    .card-header p{color:#7f8c8d;font-size:1rem}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;font-weight:500;color:#2c3e50;font-size:0.95rem}
    .input-group{display:flex;align-items:center;background-color:#f8f9fa;border-radius:8px;overflow:hidden;border:1px solid #ddd;transition:all 0.3s ease}
    .input-group:focus-within{border-color:#3498db;box-shadow:0 0 0 2px rgba(52,152,219,0.2)}
    .input-icon{padding:0 15px;color:#7f8c8d}
    input,select{width:100%;padding:14px;border:none;background:transparent;color:#2c3e50;font-size:1rem;outline:none}
    input::placeholder{color:#95a5a6}
    select{appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%237f8c8d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 15px center;background-size:15px}
    .phone-group{display:flex}
    .country-code{flex:0 0 30%;display:flex;align-items:center;background-color:#eef2f7;padding:0 15px;border-right:1px solid #ddd;font-weight:500;color:#2c3e50}
    .flag{margin-right:8px;font-size:1.2rem}
    .phone-input{flex:1}
    .checkbox-group{display:flex;align-items:flex-start;gap:12px;margin:20px 0}
    .checkbox-group input[type="checkbox"]{width:18px;height:18px;margin-top:3px;flex-shrink:0;accent-color:#4CD964;cursor:pointer}
    .terms-text{font-size:0.85rem;line-height:1.35;color:#7f8c8d;max-width:calc(100% - 32px)}
    .terms-text a{color:#3498db;text-decoration:none;font-weight:500}
    .terms-text a:hover{text-decoration:underline}
    .btn{display:block;width:100%;padding:16px;background:linear-gradient(135deg,#4CD964 0%,#2AB32A 100%);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;text-align:center;box-shadow:0 4px 10px rgba(76,217,100,0.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 15px rgba(76,217,100,0.4)}
    .btn:active{transform:translateY(0)}
    .login-link{text-align:center;margin-top:25px;font-size:0.95rem;color:#7f8c8d}
    .login-link a{color:#3498db;text-decoration:none;font-weight:500}
    .login-link a:hover{text-decoration:underline}
    .footer{margin-top:30px;text-align:center;color:rgba(255,255,255,0.7);font-size:0.85rem}
    .footer-links{margin-top:10px;display:flex;justify-content:center;gap:15px}
    .footer-links a{color:rgba(255,255,255,0.9);text-decoration:none}
    .footer-links a:hover{text-decoration:underline}
    .error-message{color:#e74c3c;background-color:#fde8e6;padding:10px;border-radius:5px;margin-top:10px;font-size:0.9rem;display:none}
    .success-message{color:#2ecc71;background-color:#e8f6ef;padding:10px;border-radius:5px;margin-top:10px;font-size:0.9rem;display:none}
    
    /* --- Nouvelles rÃ¨gles CSS pour les notifications --- */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .notification {
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      max-width: 350px;
      animation: slideIn 0.3s ease forwards;
      position: relative;
      overflow: hidden;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #4CD964 0%, #2AB32A 100%);
      color: white;
    }
    
    .notification.error {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }
    
    .notification-icon {
      margin-right: 12px;
      font-size: 1.2rem;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .notification-message {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      margin-left: 10px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .notification-close:hover {
      opacity: 1;
    }
    
    .notification-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      width: 100%;
      transform-origin: left;
      animation: progressBar 5s linear forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes progressBar {
      from {
        transform: scaleX(1);
      }
      to {
        transform: scaleX(0);
      }
    }
    
    /* Style pour les options de pays avec drapeaux */
    .country-option {
      display: flex;
      align-items: center;
    }
    
    .country-flag {
      margin-right: 8px;
      font-size: 1.2rem;
    }
    
    @media (max-width:576px){
      .card{padding:20px}
      .logo{font-size:2.2rem}
      .tagline{font-size:1rem}
      .card-header h2{font-size:1.5rem}
      .notification-container {
        left: 20px;
        right: 20px;
      }
      .notification {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Container pour les notifications -->
  <div class="notification-container" id="notificationContainer"></div>

  <div class="container">
    <div class="logo-header">
      <!-- Nouveau logo avec des piÃ¨ces superposÃ©es -->
      <div class="logo">
        <i class="fas fa-coins" style="color: #FFD700; text-shadow: 0px 0px 5px rgba(255, 215, 0, 0.5);"></i>
        <span>Cash-flowr</span>
      </div>
      <div class="tagline">La plateforme d'affiliation gamifiÃ©e</div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>CrÃ©er un compte</h2>
        <p>Rejoignez notre communautÃ© dÃ¨s aujourd'hui</p>
      </div>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <form id="registrationForm">
        <div class="form-group">
          <label for="username">Nom d'utilisateur</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-user"></i></div>
            <input type="text" id="username" name="username" required placeholder="Choisissez votre nom d'utilisateur">
          </div>
        </div>

        <div class="form-group">
          <label for="par">Par (Parrain)</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-user-friends"></i></div>
            <input type="text" id="par" name="par" placeholder="Nom d'utilisateur de votre parrain" readonly>
          </div>
        </div>

        <div class="form-group">
          <label for="email">Adresse e-mail</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-envelope"></i></div>
            <input type="email" id="email" name="email" required placeholder="exemple@email.com">
          </div>
        </div>

        <div class="form-group">
          <label for="country">Pays</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-globe"></i></div>
            <select id="country" name="country" required onchange="updateCountryCode()">
              <option value="">SÃ©lectionnez votre pays</option>
              
              <!-- Afrique Centrale -->
              <optgroup label="Afrique Centrale">
                <option value="cm" data-code="+237" selected>ðŸ‡¨ðŸ‡² Cameroun</option>
                <option value="td" data-code="+235">ðŸ‡¹ðŸ‡© Tchad</option>
                <option value="cf" data-code="+236">ðŸ‡¨ðŸ‡« RÃ©publique centrafricaine</option>
                <option value="cg" data-code="+242">ðŸ‡¨ðŸ‡¬ Congo-Brazzaville</option>
                <option value="cd" data-code="+243">ðŸ‡¨ðŸ‡© RÃ©publique dÃ©mocratique du Congo</option>
                <option value="gq" data-code="+240">ðŸ‡¬ðŸ‡¶ GuinÃ©e Ã©quatoriale</option>
                <option value="ga" data-code="+241">ðŸ‡¬ðŸ‡¦ Gabon</option>
                <option value="st" data-code="+239">ðŸ‡¸ðŸ‡¹ Sao TomÃ©-et-Principe</option>
              </optgroup>
              
              <!-- Afrique de l'Ouest -->
              <optgroup label="Afrique de l'Ouest">
                <option value="ci" data-code="+225">ðŸ‡¨ðŸ‡® CÃ´te d'Ivoire</option>
                <option value="sn" data-code="+221">ðŸ‡¸ðŸ‡³ SÃ©nÃ©gal</option>
                <option value="ml" data-code="+223">ðŸ‡²ðŸ‡± Mali</option>
                <option value="bf" data-code="+226">ðŸ‡§ðŸ‡« Burkina Faso</option>
                <option value="ne" data-code="+227">ðŸ‡³ðŸ‡ª Niger</option>
                <option value="tg" data-code="+228">ðŸ‡¹ðŸ‡¬ Togo</option>
                <option value="bj" data-code="+229">ðŸ‡§ðŸ‡¯ BÃ©nin</option>
                <option value="ng" data-code="+234">ðŸ‡³ðŸ‡¬ Nigeria</option>
                <option value="gh" data-code="+233">ðŸ‡¬ðŸ‡­ Ghana</option>
                <option value="gn" data-code="+224">ðŸ‡¬ðŸ‡³ GuinÃ©e</option>
                <option value="gw" data-code="+245">ðŸ‡¬ðŸ‡¼ GuinÃ©e-Bissau</option>
                <option value="lr" data-code="+231">ðŸ‡±ðŸ‡· Liberia</option>
                <option value="sl" data-code="+232">ðŸ‡¸ðŸ‡± Sierra Leone</option>
                <option value="gm" data-code="+220">ðŸ‡¬ðŸ‡² Gambie</option>
                <option value="mr" data-code="+222">ðŸ‡²ðŸ‡· Mauritanie</option>
              </optgroup>
              
              <!-- Afrique de l'Est -->
              <optgroup label="Afrique de l'Est">
                <option value="ke" data-code="+254">ðŸ‡°ðŸ‡ª Kenya</option>
                <option value="ug" data-code="+256">ðŸ‡ºðŸ‡¬ Ouganda</option>
                <option value="tz" data-code="+255">ðŸ‡¹ðŸ‡¿ Tanzanie</option>
                <option value="rw" data-code="+250">ðŸ‡·ðŸ‡¼ Rwanda</option>
                <option value="bi" data-code="+257">ðŸ‡§ðŸ‡® Burundi</option>
                <option value="et" data-code="+251">ðŸ‡ªðŸ‡¹ Ã‰thiopie</option>
                <option value="ss" data-code="+211">ðŸ‡¸ðŸ‡¸ Soudan du Sud</option>
                <option value="sd" data-code="+249">ðŸ‡¸ðŸ‡© Soudan</option>
                <option value="so" data-code="+252">ðŸ‡¸ðŸ‡´ Somalie</option>
                <option value="dj" data-code="+253">ðŸ‡©ðŸ‡¯ Djibouti</option>
                <option value="er" data-code="+291">ðŸ‡ªðŸ‡· Ã‰rythrÃ©e</option>
              </optgroup>
              
              <!-- Autres pays africains -->
              <optgroup label="Autres pays africains">
                <option value="dz" data-code="+213">ðŸ‡©ðŸ‡¿ AlgÃ©rie</option>
                <option value="eg" data-code="+20">ðŸ‡ªðŸ‡¬ Ã‰gypte</option>
                <option value="ly" data-code="+218">ðŸ‡±ðŸ‡¾ Libye</option>
                <option value="ma" data-code="+212">ðŸ‡²ðŸ‡¦ Maroc</option>
                <option value="tn" data-code="+216">ðŸ‡¹ðŸ‡³ Tunisie</option>
                <option value="ao" data-code="+244">ðŸ‡¦ðŸ‡´ Angola</option>
                <option value="mz" data-code="+258">ðŸ‡²ðŸ‡¿ Mozambique</option>
                <option value="zm" data-code="+260">ðŸ‡¿ðŸ‡² Zambie</option>
                <option value="zw" data-code="+263">ðŸ‡¿ðŸ‡¼ Zimbabwe</option>
                <option value="mw" data-code="+265">ðŸ‡²ðŸ‡¼ Malawi</option>
                <option value="na" data-code="+264">ðŸ‡³ðŸ‡¦ Namibie</option>
                <option value="bw" data-code="+267">ðŸ‡§ðŸ‡¼ Botswana</option>
                <option value="sz" data-code="+268">ðŸ‡¸ðŸ‡¿ Eswatini</option>
                <option value="ls" data-code="+266">ðŸ‡±ðŸ‡¸ Lesotho</option>
                <option value="mg" data-code="+261">ðŸ‡²ðŸ‡¬ Madagascar</option>
                <option value="mu" data-code="+230">ðŸ‡²ðŸ‡º Maurice</option>
                <option value="sc" data-code="+248">ðŸ‡¸ðŸ‡¨ Seychelles</option>
                <option value="cv" data-code="+238">ðŸ‡¨ðŸ‡» Cap-Vert</option>
              </optgroup>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="phone">NumÃ©ro de tÃ©lÃ©phone</label>
          <div class="input-group phone-group">
            <div class="country-code"><span id="selectedFlag" class="flag">ðŸ‡¨ðŸ‡²</span><span id="countryCode">+237</span></div>
            <div class="input-icon"><i class="fas fa-phone"></i></div>
            <input type="tel" id="phone" name="phone" required class="phone-input" placeholder="XX XXX XXX">
          </div>
        </div>

        <div class="form-group">
          <label for="password">Mot de passe</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-lock"></i></div>
            <input type="password" id="password" name="password" required placeholder="CrÃ©ez un mot de passe sÃ©curisÃ©">
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmer le mot de passe</label>
          <div class="input-group">
            <div class="input-icon"><i class="fas fa-lock"></i></div>
            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirmez votre mot de passe">
          </div>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="terms" name="terms" required>
          <div class="terms-text">En cochant cette case, j'accepte les <a href="terms.html">Conditions d'utilisation</a> et la <a href="privacy.html">Politique de confidentialitÃ©</a> de Cash-flowr.<br>Mon compte devra Ãªtre activÃ© <strong>aprÃ¨s mon paiement</strong>.</div>
        </div>

        <button type="submit" class="btn"><i class="fas fa-user-plus"></i> S'inscrire maintenant</button>
      </form>

      <div class="login-link">Vous avez dÃ©jÃ  un compte? <a href="login.html">Connectez-vous</a></div>
    </div>

    <div class="footer">
      <div>Â© 2025 Cash-flowr. Tous droits rÃ©servÃ©s.</div>
      <div class="footer-links">
        <a href="terms.html">Conditions d'utilisation</a>
        <a href="privacy.html">Politique de confidentialitÃ©</a>
        <a href="support.html">Support</a>
        <!-- Nouveau lien "propulsÃ© par SHB" -->
        <a href="https://social-boost-horizon-new-shb.vercel.app" target="_blank">Site propulsÃ© par SHB</a>
      </div>
    </div>
  </div>

  <!-- ---------- Firebase + logique d'inscription (modulaire v9) ---------- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // --- CONFIG --- (vÃ©rifie que c'est le projet oÃ¹ tu as dÃ©ployÃ© les rÃ¨gles)
    const firebaseConfig = {
      apiKey: "AIzaSyCjGisjgbFc2ZE0BFgdhlUao8bCCeuKP1k",
      authDomain: "cash-flowr.firebaseapp.com",
      projectId: "cash-flowr",
      storageBucket: "cash-flowr.firebasestorage.app",
      messagingSenderId: "1091928501310",
      appId: "1:1091928501310:web:4f4de306cde36f378ff56f",
      measurementId: "G-5SF6VDLZCB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // SystÃ¨me de notification (toast)
    function showNotification(type, title, message, duration = 5000) {
      const notificationContainer = document.getElementById('notificationContainer');
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
      
      notification.innerHTML = `
        <i class="fas ${icon} notification-icon"></i>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close">
          <i class="fas fa-times"></i>
        </button>
        <div class="notification-progress"></div>
      `;
      
      notificationContainer.appendChild(notification);
      
      // Fermer la notification aprÃ¨s la durÃ©e spÃ©cifiÃ©e
      const closeNotification = () => {
        notification.style.animation = 'slideIn 0.3s ease reverse forwards';
        setTimeout(() => {
          notificationContainer.removeChild(notification);
        }, 300);
      };
      
      // Bouton de fermeture
      const closeButton = notification.querySelector('.notification-close');
      closeButton.addEventListener('click', closeNotification);
      
      // Barre de progression
      const progressBar = notification.querySelector('.notification-progress');
      progressBar.style.animationDuration = `${duration}ms`;
      
      // Fermeture automatique
      setTimeout(closeNotification, duration);
    }

    // Helpers UI
    const errorEl = document.getElementById('errorMessage');
    const successEl = document.getElementById('successMessage');

    function showError(message) {
      showNotification('error', 'Erreur', message);
    }
    
    function showSuccess(message) {
      showNotification('success', 'SuccÃ¨s', message);
    }

    // utils
    function getFlag(countryCode){
      const flags = {
        'ci':'ðŸ‡¨ðŸ‡®','fr':'ðŸ‡«ðŸ‡·','sn':'ðŸ‡¸ðŸ‡³','cm':'ðŸ‡¨ðŸ‡²','ml':'ðŸ‡²ðŸ‡±','bf':'ðŸ‡§ðŸ‡«','ne':'ðŸ‡³ðŸ‡ª',
        'tg':'ðŸ‡¹ðŸ‡¬','bj':'ðŸ‡§ðŸ‡¯','cd':'ðŸ‡¨ðŸ‡©','td':'ðŸ‡¹ðŸ‡©','cf':'ðŸ‡¨ðŸ‡«','cg':'ðŸ‡¨ðŸ‡¬','gq':'ðŸ‡¬ðŸ‡¶',
        'ga':'ðŸ‡¬ðŸ‡¦','st':'ðŸ‡¸ðŸ‡¹','ng':'ðŸ‡³ðŸ‡¬','gh':'ðŸ‡¬ðŸ‡­','gn':'ðŸ‡¬ðŸ‡³','gw':'ðŸ‡¬ðŸ‡¼','lr':'ðŸ‡±ðŸ‡·',
        'sl':'ðŸ‡¸ðŸ‡±','gm':'ðŸ‡¬ðŸ‡²','mr':'ðŸ‡²ðŸ‡·','ke':'ðŸ‡°ðŸ‡ª','ug':'ðŸ‡ºðŸ‡¬','tz':'ðŸ‡¹ðŸ‡¿','rw':'ðŸ‡·ðŸ‡¼',
        'bi':'ðŸ‡§ðŸ‡®','et':'ðŸ‡ªðŸ‡¹','ss':'ðŸ‡¸ðŸ‡¸','sd':'ðŸ‡¸ðŸ‡©','so':'ðŸ‡¸ðŸ‡´','dj':'ðŸ‡©ðŸ‡¯','er':'ðŸ‡ªðŸ‡·',
        'dz':'ðŸ‡©ðŸ‡¿','eg':'ðŸ‡ªðŸ‡¬','ly':'ðŸ‡±ðŸ‡¾','ma':'ðŸ‡²ðŸ‡¦','tn':'ðŸ‡¹ðŸ‡³','ao':'ðŸ‡¦ðŸ‡´','mz':'ðŸ‡²ðŸ‡¿',
        'zm':'ðŸ‡¿ðŸ‡²','zw':'ðŸ‡¿ðŸ‡¼','mw':'ðŸ‡²ðŸ‡¼','na':'ðŸ‡³ðŸ‡¦','bw':'ðŸ‡§ðŸ‡¼','sz':'ðŸ‡¸ðŸ‡¿','ls':'ðŸ‡±ðŸ‡¸',
        'mg':'ðŸ‡²ðŸ‡¬','mu':'ðŸ‡²ðŸ‡º','sc':'ðŸ‡¸ðŸ‡¨','cv':'ðŸ‡¨ðŸ‡»'
      };
      return flags[countryCode] || 'ðŸ‡¨ðŸ‡²';
    }
    
    function updateCountryCode() {
      const countrySelect = document.getElementById('country');
      const selectedOption = countrySelect.options[countrySelect.selectedIndex];
      const code = selectedOption?.getAttribute('data-code') || '+237';
      const flag = getFlag(selectedOption?.value);
      document.getElementById('countryCode').textContent = code;
      document.getElementById('selectedFlag').textContent = flag;
    }

    // quick existence check (UI-level; final check in transaction)
    async function checkUsernameExists(username){
      if(!username) return false;
      try {
        const ref = doc(db, 'usernames', username);
        const snap = await getDoc(ref);
        return snap.exists();
      } catch (err) {
        console.error('checkUsernameExists error', err);
        // return true conservatively? we'll just return false to let transaction handle conflicts.
        return false;
      }
    }

    document.getElementById('registrationForm').addEventListener('submit', async function(e){
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const country = document.getElementById('country').value;
      const phone = document.getElementById('phone').value.trim();
      const parrain = document.getElementById('par').value || null;

      // basic validation
      if (!username) { showError('Choisissez un nom d\'utilisateur.'); return; }
      if (password !== confirmPassword) { showError('Les mots de passe ne correspondent pas.'); return; }
      if (!document.getElementById('terms').checked) { showError('Veuillez accepter les conditions.'); return; }

      // quick username check for UX (not a replacement for transaction)
      const quickExists = await checkUsernameExists(username);
      if (quickExists) { showError('Ce nom d\'utilisateur est dÃ©jÃ  pris.'); return; }

      // UI state
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
      submitBtn.disabled = true;

      try {
        // 1) create auth user
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // 2) ensure token is ready (avoid permission race)
        await user.getIdToken(true);

        // 3) prepare user data
        const userData = {
          uid: user.uid,
          username,
          email,
          country,
          phone: document.getElementById('countryCode').textContent + (phone || ''),
          parrain,
          createdAt: new Date(),
          status: 'pending_payment'
        };

        // 4) run a transaction: check username doc doesn't exist then set both docs
        await runTransaction(db, async (tx) => {
          const usernameRef = doc(db, 'usernames', username);
          const usernameSnap = await tx.get(usernameRef);
          if (usernameSnap.exists()) {
            // username already taken â€” abort
            throw new Error('USERNAME_TAKEN_IN_TRANSACTION');
          }
          const userRef = doc(db, 'users', user.uid);
          tx.set(userRef, userData);
          tx.set(usernameRef, { uid: user.uid, createdAt: new Date() });
        });

        // 5) update profile displayName
        await updateProfile(user, { displayName: username });

        // 6) success -> redirect to paiement.html (make sure file exists at same path)
        showSuccess('Votre compte a Ã©tÃ© crÃ©Ã© avec succÃ¨s ! Redirection vers la page de paiement...');
        // small delay for UX
        setTimeout(() => {
          // use assign so that devtools shows navigation; keep it relative
          window.location.assign('paiement.html');
        }, 3000);

      } catch (error) {
        console.error('Registration error:', error);

        // Friendly error messages
        let message = "Une erreur s'est produite lors de l'inscription.";
        if (error.code === 'auth/email-already-in-use') message = "Cette adresse email est dÃ©jÃ  utilisÃ©e par un autre compte.";
        else if (error.code === 'auth/invalid-email') message = "L'adresse email n'est pas valide.";
        else if (error.code === 'auth/operation-not-allowed') message = "L'inscription par email/mot de passe n'est pas activÃ©e dans Firebase Auth.";
        else if (error.code === 'auth/weak-password') message = "Le mot de passe est trop faible (min 6 caractÃ¨res).";
        else if (error.message === 'USERNAME_TAKEN_IN_TRANSACTION') message = "Le nom d'utilisateur a Ã©tÃ© pris pendant l'inscription. Choisissez-en un autre.";
        else if (error.code === 'permission-denied' || /permission-denied/i.test(error.message)) {
          message = "Permission refusÃ©e lors de l'Ã©criture en base. VÃ©rifie tes rÃ¨gles Firestore (users + usernames).";
        } else {
          // use server error message if available
          message = error.message || message;
        }

        showError(message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // init UI and prefill par param
    document.addEventListener('DOMContentLoaded', () => {
      // DÃ©finir le Cameroun comme option sÃ©lectionnÃ©e par dÃ©faut
      document.getElementById('country').value = 'cm';
      updateCountryCode();
      
      const parValue = (new URLSearchParams(location.search)).get('par') || '';
      if (parValue) document.getElementById('par').value = parValue;
    });
  </script>
</body>
</html>